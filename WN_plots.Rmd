---
title: "WN"
output: html_notebook
---

```{r setup}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(cowplot)
library(gplots)
library(ggplot2)
library(patternplot)
library(lme4)
library(visreg)
library(tidyr)
library(magrittr) 
library(dplyr)
library(ggpubr)
library(lme4)
library(lsmeans)
library(emmeans)

```

```{r data}
mice_info<-read.csv('qial_animals_with_age.csv')

data1<-read.csv('Winding/210614MWM_positions.csv', header=TRUE)
data2<-read.csv('Winding/220207MWM_positions.csv', header=TRUE)
data3<-read.csv('Winding/220606MWM_positions.csv', header=TRUE)
data4<-read.csv('Winding/190715MWM_positions.csv', header=TRUE)
data5<-read.csv('Winding/210503MWM_positions.csv', header=TRUE)
data6<-read.csv('Winding/200302MWM_positions.csv', header=TRUE)
data7<-read.csv('Winding/211004MWM_positions.csv', header=TRUE)
data8<-read.csv('Winding/210811MWM_positions.csv', header=TRUE)
data9<-read.csv('Winding/190919MWM_positions.csv', header=TRUE)
data10<-read.csv('Winding/220509MWM_positions.csv', header=TRUE)
data11<-read.csv('Winding/220110MWM_positions.csv', header=TRUE)
data12<-read.csv('Winding/220307MWM_positions.csv', header=TRUE)
data13<-read.csv('Winding/220404MWM_positions.csv', header=TRUE)
data14<-read.csv('Winding/190617MWM_positions.csv', header=TRUE)
data15<-read.csv('Winding/210118MWM_positions.csv', header=TRUE)
data16<-read.csv('Winding/201016MWM_positions.csv', header=TRUE)
data17<-read.csv('Winding/200331MWM_positions.csv', header=TRUE)
data18<-read.csv('Winding/211122MWM_positions.csv', header=TRUE)
data19<-read.csv('Winding/210906MWM_positions.csv', header=TRUE)
data20<-read.csv('Winding/221128MWM_positions.csv', header=TRUE)
data21<-read.csv('Winding/220808MWM_positions.csv', header=TRUE)
data22<-read.csv('Winding/220422MWM_positions.csv', header=TRUE)
data23<-read.csv('Winding/210222MWM_positions.csv', header=TRUE)
#data24<-read.csv('Winding/210906MWM_positions.csv', header=TRUE)


data_joan<-read.csv('Winding/JoanMWM_positions.csv', header=TRUE)
```

```{r merge-data}

wn<-rbind(data1,data2,data3,data4,data5,data6,data7,data8,data9,data10,data11,
          data12,data13,data14,data15,data16,data17,data18,data19, data20, data21,
          data22, data23)

# creating column with cohort ID and stage and time
wn['CohortID']=as.integer(substr(wn$Row, 1, 6))
wn$AnimalID=substr(wn$Row, 1, 9)

index_temp = substr(wn$AnimalID,9,9) == "_"
wn$AnimalID[index_temp] = substr(wn$AnimalID[index_temp],1,8)
wn$AnimalID = gsub("-" , "_", wn$AnimalID)

n_last_time <- 15                                # Specify number of characters to extract

wn$Time=as.integer(substr(wn$Row, nchar(wn$Row)-n_last_time+1, nchar(wn$Row)-n_last_time+1))

n_last_stage <- 21
wn$Stage<-substr(wn$Row, nchar(wn$Row) - n_last_stage + 1, nchar(wn$Row)-n_last_stage+4)

# reading in other MWM data 

mwm_data<-read.csv('mwm_data.csv', header=TRUE)
mwm_data<-subset(mwm_data, select=-c(X, age))

# calculating normalized distances in each quadrant

mwm_data$Distance=mwm_data$Distance/10
mwm_data$NE...distance=mwm_data$NE...distance/10
mwm_data$NW...distance=mwm_data$NW...distance/10
mwm_data$SE...distance=mwm_data$SE...distance/10
mwm_data$SW...distance=mwm_data$SW...distance/10

#Normalize time and distance in target region
mwm_data$NormSWTime<-mwm_data$SW...time/mwm_data$Duration
mwm_data$NormSWDist<-mwm_data$SW...distance/mwm_data$Distance
mwm_data<-subset(mwm_data, (NormSWTime <= 1))

#Normalize Probe Distances
mwm_data$DistTot<-mwm_data$NE...distance+mwm_data$NW...distance+mwm_data$SE...distance+mwm_data$SW...distance
mwm_data$NE.Dist.Norm<-mwm_data$NE...distance/mwm_data$DistTot
mwm_data$NW.Dist.Norm<-mwm_data$NW...distance/mwm_data$DistTot
mwm_data$SE.Dist.Norm<-mwm_data$SE...distance/mwm_data$DistTot
mwm_data$SW.Dist.Norm<-mwm_data$SW...distance/mwm_data$DistTot

#Normalize Probe Times
mwm_data$TimeTot<-mwm_data$NE...time+mwm_data$NW...time+mwm_data$SE...time+mwm_data$SW...time
mwm_data$NE.Time.Norm<-mwm_data$NE...time/mwm_data$TimeTot
mwm_data$NW.Time.Norm<-mwm_data$NW...time/mwm_data$TimeTot
mwm_data$SE.Time.Norm<-mwm_data$SE...time/mwm_data$TimeTot
mwm_data$SW.Time.Norm<-mwm_data$SW...time/mwm_data$TimeTot

#Normalize time and distance in target region probe
mwm_data$NormSWTime<-mwm_data$SW...time/mwm_data$Duration
mwm_data$NormSWDist<-mwm_data$SW...distance/mwm_data$Distance
mwm_data<-subset(mwm_data, (NormSWTime <= 1))

# Converting NormSWDiet values to numeric
mwm_data$NormSWDist <- as.numeric(mwm_data$NormSWDist)
mwm_data$NormSWDist <- as.numeric(mwm_data$NormSWDist)



# merging data 
allMWM <- left_join(wn, mwm_data, by = c("AnimalID" = "Animal", "Time"="Trial", 'Stage'='Stage')) %>%
  distinct(Row, .keep_all =TRUE)

allMWM$NormDist<-allMWM$Distance/(allMWM$Winding_numbers+1)

#write.csv(allMWM, '/Users/AnnaMacFarlane/Desktop/AllMWM_Combined.csv')


# merging with additional animal information
#mwm_wn <- left_join(wn, mice_info, by = c("AnimalID" = "BadeaID"))
mwm_wn <- left_join(allMWM, mice_info, by = c("AnimalID" = "BadeaID"))

# setting age groups
mwm_wn<-mwm_wn %>% 
  mutate(Age_group = case_when(
    Age_Substracted.x <= 16 ~ 'Young',
    Age_Substracted > 16 ~ 'Old'
  ))

#write.csv(mwm_wn, '/Users/AnnaMacFarlane/Desktop/MWM_AWN_Combined.csv')

#all_mwm<-read.csv('mwm_data', header=TRUE)
# filter by age
#mwm_wn<-mwm_wn %>% 
#  filter(Age_Substracted == '12 months')

```


```

```{r joan}
joan<-read.csv('joan_wn.csv', header=TRUE)
joan_ref<-read.csv('JOAN_MWM_combined.csv', header=TRUE)

joan_wn_all<-left_join(joan, joan_ref, by = c("CohortID" = "Animal_ID"))

joan_wn<-joan_wn_all %>% 
  filter(!is.na(X)) %>% 
  filter(Stage != "Probe_D5" | Stage != "Probe_D8") %>%
  mutate(Stage = case_when( 
    Stage == "Day1" ~ "Day 1",
    Stage == "Day2" ~ "Day 2",
    Stage == "Day3" ~ "Day 3",
    Stage == "Day4" ~ "Day 4",
    Stage == "Day5" ~ "Day 5"
  )) %>% 
  filter(!is.na(Stage)) %>% 
  group_by(Stage)
  

ggline(joan_wn, x='Stage', y='Winding_numbers',
       #facet.by=c('Sex'),
       error.plot='errorbar', add='mean_se', size=1,
       point.size=1.5, legend='top')

ggline(joan_wn, x='Stage', y='Winding_numbers',
       error.plot='errorbar', add='mean_se')
```

```{r organize}
hn_trials <- mwm_wn %>% 
  filter(Geno == "APOE22HN" | Geno == "APOE33HN" | Geno == "APOE44HN") 
e_trials <- mwm_wn %>% 
  filter(Geno == "APOE22" | Geno == "APOE33" | Geno == "APOE44") %>% 
  filter(Stage != 'e_D5' & Stage != 'e_D8')
e2 <- mwm_wn %>% 
  filter(Geno == "APOE22HN" | Geno == "APOE22")
e3 <- mwm_wn %>% 
  filter(Geno == "APOE33HN" | Geno == "APOE33")
e4 <- mwm_wn %>% 
  filter(Geno == "APOE44HN" | Geno == "APOE44")
```

```{r plots}
ggline(hn_trials, x='Stage', y='Winding_numbers',
       color='Geno', fill='Geno', facet.by=c('Diet','Sex_other'),
       error.plot='errorbar', add='mean_se', 
       palette = c("#6a0dad", "#008000", "#FF0000"), size=1,
       point.size=1.5, legend='top')

ggline(e_trials, x='Stage', y='Winding_numbers', 
       color='Geno', fill='Geno', facet.by=c('Diet','Sex_other'),
       error.plot='errorbar', add='mean_se', 
       palette = c("#1BCC97", "#1B50CC", "#CC1BA8"), size=1,
       point.size=1.5,  legend='top')

ggline(e2, x='Stage', y='Winding_numbers', 
       color='Geno', fill='Geno', facet.by=c('Diet','Sex_other'),
       error.plot='errorbar', add='mean_se', 
      palette = c("#1BCC97", "#6a0dad"), size=1,
       point.size=1.5,  legend='top')

ggline(e3, x='Stage', y='Winding_numbers', 
       color='Geno', fill='Geno', facet.by=c('Diet','Sex_other'),
       error.plot='errorbar', add='mean_se', 
       palette = c("#1B50CC", "#008000"), size=1,
       point.size=1.5,  legend='top')

ggline(e4, x='Stage', y='Winding_numbers', 
       color='Geno', fill='Geno', facet.by=c('Diet','Sex_other'),
       error.plot='errorbar', add='mean_se', 
       palette = c("#CC1BA8", "#FF0000"), size=1,
       point.size=1.5,  legend='top')
```

```{r facet-by-sex}
ggline(e_trials, x='Stage', y='Winding_numbers', 
       color='Sex_other', fill='Sex_other', facet.by=c('Geno'),
       error.plot='errorbar', add='mean_se', 
       palette = c("red", "blue"), size=1,
       point.size=1.5,  legend='top',
       legend.title='Sex') 
       
ggline(e_trials, x='Stage', y='Winding_numbers', 
       color='Sex_other', fill='Sex_other', facet.by=c('Age_group','Geno'),
       error.plot='errorbar', add='mean_se', 
       palette = c("red", "blue"), size=1,
       point.size=1.5,  legend='top',
       legend.title='Sex')
       
ggline(e_trials, x='Stage', y='Winding_numbers', 
       color='Age_group', fill='Age_group', facet.by=c('Sex_other','Geno'),
       error.plot='errorbar', add='mean_se', 
       palette = c("green", "purple"), size=1,
       point.size=1.5,  legend='top', legend.title='Sex')

```

```{r norm-dist-plots}
ggline(e_trials, x='Stage', y='NormDist', 
       color='Geno', fill='Geno', facet.by=c('Diet','Sex_other'),
       error.plot='errorbar', add='mean_se', 
       palette = c("#1BCC97", "#1B50CC", "#CC1BA8"), size=1,
       point.size=1.5,  legend='top', legend.title='Sex')
       
ggline(e_trials, x='Stage', y='NormDist', 
       color='Sex_other', fill='Sex_other', facet.by=c('Geno'),
       error.plot='errorbar', add='mean_se', 
       palette = c("red", "blue"), size=1,
       point.size=1.5,  legend='top',
       legend.title='Sex') 
       
ggline(e_trials, x='Stage', y='NormDist', 
       color='Sex_other', fill='Sex_other', facet.by=c('Age_group','Geno'),
       error.plot='errorbar', add='mean_se', 
       palette = c("red", "blue"), size=1,
       point.size=1.5,  legend='top',
       legend.title='Sex')
       
ggline(e_trials, x='Stage', y='NormDist', 
       color='Age_group', fill='Age_group', facet.by=c('Sex_other','Geno'),
       error.plot='errorbar', add='mean_se', 
       palette = c("green", "purple"), size=1,
       point.size=1.5,  legend='top', legend.title='Sex')

```

```{r post-hoc-reg}
library(lmerTest)

#r_trials<_reg_trials %>% 
#  filter(!is.na())

mod_reg<-lmer(Winding~factor(Genotype)*Treatment.y+Stage+(1|Animal), reg_trials)

# within day 5 and within day 8
mod_probe<-lme(NormSWDist~factor(Genotype)*Treatment.y+Stage, probe_trials)

mix_reg<-emmeans(mod_reg, "Genotype", adjust = "Tukey")
mix_probe<-emmeans(mod_probe, "Genotype", adjust = "Tukey")

pairs(mix_reg)
pairs(mix_probe)

a1<-anova(mod_reg)
a2<-anova(mod_probe)

a1
a2
```
